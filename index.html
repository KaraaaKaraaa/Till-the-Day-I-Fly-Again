<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Till the Day I Fly Again</title>
<style>
  body {margin:0;font-family:sans-serif;background:#111;color:#eee;}
  .container{max-width:900px;margin:20px auto;padding:10px;}
  header{display:flex;flex-direction:column;justify-content:flex-start;align-items:flex-start;}
  h1{margin:0;font-size:24px;}
  h5{margin:4px 0 10px 0;}
  .story-summary{margin:10px 0;font-style:italic;color:#ccc;}
  .sidebar{background:#1a1a1a;padding:10px;border-radius:10px;float:left;width:200px;box-sizing:border-box;}
  .chapter{padding:8px;margin-bottom:6px;background:#222;border-radius:6px;cursor:pointer;}
  .chapter.active{background:#444;}
  .viewer{margin-left:220px;padding:10px;}
  img.page-img{max-width:100%;border-radius:8px;margin-bottom:10px;}
  .nav{margin-top:10px;}
  button{padding:8px 14px;margin-right:6px;border:none;border-radius:6px;background:#4a78ff;color:#fff;cursor:pointer;}
  #song-display{margin-top:5px;font-style:italic;}
  #music-label{margin-top:5px;font-weight:bold;color:#aaa;}

  /* ===================== MOBILE STYLES ===================== */
  @media (max-width: 768px) {
    .sidebar {float:none;width:100%;margin-bottom:10px;}
    .viewer {margin-left:0;padding:5px;}
    button {padding:10px 16px;font-size:16px;margin-top:5px;}
    .container {padding:10px;}
    h1 {font-size:22px;}
    .story-summary {font-size:14px;}
    #music-label, #song-display {font-size:14px;}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1 id="site-title">Till the Day I Fly Again</h1>
    <div class="story-summary">
      Silver Hoshino is a 15-year-old boy struggling with past trauma and finding solace in music and guitar. This story follows him and his friends as they navigate trust, grief, and self-expression trying to learn what it means to "live".
    </div>
  </header>

  <!-- Music controls -->
  <div style="margin:10px 0;">
    <div id="music-label">This is what Silver listens to:</div>
    <div id="song-display">No song playing</div>
    <button id="mute-btn">Mute</button>
  </div>
  <audio id="bg-audio" autoplay></audio>

  <div class="sidebar" id="chapters-list">No chapters loaded</div>
  <div class="viewer" id="viewer">
    <div id="chapter-title"></div>
    <div id="page-container"></div>
    <div class="nav">
      <button id="prev-page">Prev</button>
      <button id="next-page">Next</button>
    </div>
  </div>
</div>

<!-- Load your comics.js here -->
<script src="comics.js"></script>
<script>
// ===================== STATE =====================
let state = { chapterIndex:0, pageIndex:0 };

const els = {
  chaptersList: document.getElementById('chapters-list'),
  chapterTitle: document.getElementById('chapter-title'),
  pageContainer: document.getElementById('page-container'),
  prevBtn: document.getElementById('prev-page'),
  nextBtn: document.getElementById('next-page'),
  siteTitle: document.getElementById('site-title'),
  muteBtn: document.getElementById('mute-btn'),
  songDisplay: document.getElementById('song-display'),
  audio: document.getElementById('bg-audio'),
  viewer: document.getElementById('viewer')
};

// ===================== CHAPTERS =====================
function renderChapters(){
  els.chaptersList.innerHTML = '';
  if(!db.chapters.length){ els.chaptersList.textContent="No chapters"; return; }
  db.chapters.forEach((c,i)=>{
    const div = document.createElement('div');
    div.className='chapter'+(i===state.chapterIndex?' active':'');
    div.textContent = c.title;
    div.onclick = ()=>{ state.chapterIndex=i; state.pageIndex=0; showPage(i,0); renderChapters(); };
    els.chaptersList.appendChild(div);
  });
}

function showPage(ci,pi){
  if(!db.chapters.length) return;
  const chap = db.chapters[ci];
  state.chapterIndex=ci; state.pageIndex=pi;
  els.chapterTitle.textContent = chap.title + ' - Page ' + (pi+1) + '/' + chap.pages.length;
  els.pageContainer.innerHTML = `<img src="${chap.pages[pi]}" class="page-img"/>`;
  els.prevBtn.disabled = (pi===0);
  els.nextBtn.disabled = (pi>=chap.pages.length-1);
}

els.prevBtn.onclick = ()=>{ if(state.pageIndex>0) showPage(state.chapterIndex,state.pageIndex-1); }
els.nextBtn.onclick = ()=>{ const p=state.pageIndex+1; if(p<db.chapters[state.chapterIndex].pages.length) showPage(state.chapterIndex,p); }

els.siteTitle.textContent = db.title || "Till the Day I Fly Again";
renderChapters();
showPage(0,0);

// ===================== MUSIC =====================
// List your songs manually here
const songs = [
  'music/Sienna - The Marias.mp3',
  'music/Let Down - Radiohead.mp3',
];

// Pick a random song to start
let songIndex = Math.floor(Math.random() * songs.length);

function playSong(index){
  els.audio.src = songs[index];
  els.audio.play().catch(()=>{}); // attempt autoplay
  const name = songs[index].split('/').pop().replace('.mp3','');
  els.songDisplay.textContent = "Now Playing: " + name;
}

// Cycle to next song when current ends
els.audio.addEventListener('ended', () => {
  songIndex = (songIndex + 1) % songs.length;
  playSong(songIndex);
});

// Initial song
playSong(songIndex);

// Mute/unmute toggle
els.muteBtn.onclick = () => {
  els.audio.muted = !els.audio.muted;
  els.muteBtn.textContent = els.audio.muted ? "Unmute" : "Mute";
};

// ===================== SWIPE =====================
let touchStartX = 0;
let touchEndX = 0;

els.viewer.addEventListener('touchstart', e => {
  touchStartX = e.changedTouches[0].screenX;
}, false);

els.viewer.addEventListener('touchend', e => {
  e.preventDefault(); // prevent scrolling
  touchEndX = e.changedTouches[0].screenX;
  handleGesture();
}, false);

function handleGesture() {
  if(touchEndX < touchStartX - 50){ // swipe left
    const next = state.pageIndex + 1;
    if(next < db.chapters[state.chapterIndex].pages.length) showPage(state.chapterIndex, next);
  }
  if(touchEndX > touchStartX + 50){ // swipe right
    const prev = state.pageIndex - 1;
    if(prev >= 0) showPage(state.chapterIndex, prev);
  }
}
</script>

</body>
</html>
